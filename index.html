<?php

include_once('conexao.php');
session_start();
include_once 'conexaologin.php';


if ((!isset($_SESSION['usuarioEmail'])) and (!isset($_SESSION['usuarioSenha']))) {
    $_SESSION['usuarioNome'] = $resultado['nome'];
    $_SESSION['usuarioCargo'] = $resultado['cargo'];
    header("Location: index.php");
}
if (empty($_SESSION['usuarioNiveisAcessoId'])) {
    header("Location: index.php");
}


if ($_SESSION['usuarioNiveisAcessoId'] == "3") {
    header("Location: comercial.php");
}
if ($_SESSION['usuarioNiveisAcessoId'] == "4") {
    header("Location: tmk.php");
}
if ($_SESSION['usuarioNiveisAcessoId'] == "5") {
    header("Location: tmkc.php");
}
if ($_SESSION['usuarioNiveisAcessoId'] == "6") {
    header("Location: instrutor.php");
}
if ($_SESSION['usuarioNiveisAcessoId'] == "7") {
    header("Location: secretaria.php");
}
if ($_SESSION['usuarioNiveisAcessoId'] == "8") {
    header("Location: abrirmesdia.php");
}








?>

<?php
if (isset($_POST['nomecandidato']) || isset($_POST['cargocandidato']) || isset($_POST['bairro']) || isset($_POST['cnh']) || isset($_POST['veiculo']) || isset($_POST['datarec']) || isset($_POST['1data']) || isset($_POST['2data'])) {
    // Inicializa uma array para armazenar as condi��es de pesquisa
    $condicoes = array();

    // Verifica cada campo do formul�rio e adiciona as condi��es de pesquisa se estiver preenchido
    if (!empty($_POST['nomecandidato'])) {
        $condicoes[] = "nome LIKE '%" . $_POST['nomecandidato'] . "%'";
    }
    if (!empty($_POST['cargocandidato'])) {
        $condicoes[] = "cargo LIKE '%" . $_POST['cargocandidato'] . "%'";
    }
    if (!empty($_POST['bairro'])) {
        $condicoes[] = "bairro LIKE '%" . $_POST['bairro'] . "%'";
    }
    if (!empty($_POST['cnh'])) {
        $condicoes[] = "cnh LIKE '%" . $_POST['cnh'] . "%'";
    }
    if (!empty($_POST['veiculo'])) {
        $condicoes[] = "veiculo LIKE '%" . $_POST['veiculo'] . "%'";
    }
    if (!empty($_POST['datarec'])) {
        $condicoes[] = "datarec LIKE '%" . $_POST['datarec'] . "%'";
    }
    if (!empty($_POST['1data']) && !empty($_POST['2data'])) {
        $condicoes[] = "data BETWEEN '" . $_POST['1data'] . "' AND '" . $_POST['2data'] . "'";
    }

    // Constr�i a parte WHERE da consulta
    $where = "";
    if (!empty($condicoes)) {
        $where = " WHERE " . implode(" AND ", $condicoes);
    }

    // Constr�i a consulta SQL completa
    $sql = "SELECT * FROM pendenciasalmoxarifado" . $where . " LIMIT 1500";

    // Executa a consulta
    $resultado_msg_contatos = mysqli_query($ligar, $sql);
} else {
    // Se o formul�rio n�o foi enviado, define vari�veis para pagina��o
    $pagina = (isset($_GET['pagina'])) ? $_GET['pagina'] : 1;

    // Selecionar todos os itens da tabela 
    $result_msg_contato = "SELECT * FROM pendenciasalmoxarifado";
    $resultado_msg_contato = mysqli_query($ligar, $result_msg_contato);

    // Contar o total de itens
    $total_msg_contatos = mysqli_num_rows($resultado_msg_contato);

    // Setar a quantidade de itens por p�gina
    $quantidade_pg = 1500;

    // Calcular o n�mero de p�ginas 
    $num_pagina = ceil($total_msg_contatos / $quantidade_pg);

    // Calcular o in�cio da visualiza��o
    $inicio = ($quantidade_pg * $pagina) - $quantidade_pg;

    // Selecionar os itens da p�gina
    $result_msg_contatos = "SELECT * FROM pendenciasalmoxarifado ORDER BY id DESC LIMIT $inicio, $quantidade_pg";
    $resultado_msg_contatos = mysqli_query($ligar, $result_msg_contatos);
    $total_msg_contatos = mysqli_num_rows($resultado_msg_contatos);
}
?>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GESTÃO DE ESTOQUE</title>
    <meta name="author" content="Klebeson Gomes" />

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet" />

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="css/ie10-viewport-bug-workaround.css" rel="stylesheet" />

    <!-- Custom styles for this template -->
    <link href="css/signin.css" rel="stylesheet" />

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9
      ]><script src="../../assets/js/ie8-responsive-file-warning.js"></script
    ><![endif]-->
    <script src="js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
      crossorigin="anonymous"
    />
    <style>
      .sidebar {
        width: 20vw;
        height: 100vh;
        position: absolute;
        border-right: 2px solid gray;
      }

      .sidebarPerfil {
        margin: 5%;
        display: flex;
        max-height: 10vh;
        align-items: center;
      }

      .sidebarPerfilImg {
        height: 10vh;
      }

      .sidebarPerfilText {
        display: grid;
        margin-left: 0.5vw;
      }

      .sidebarPerfilText h1 {
        font-size: 1.5em;
        margin: 0px;
      }

      .sidebarPerfilText h3 {
        font-size: 1.2em;
        margin: 0px;
      }

      .sidebarRotas {
        border-top: 1px solid gray;
        width: 20vw;
        display: grid;
        justify-content: space-around;
      }

      .sidebarRotas a{
        width: 20vw;
        padding: 1vh 0px 1vh 2vw ;
      }

      .sidebarRotas a:hover{
        background-color: gold;
      }

      .sidebarRotas h3{
        padding-left: 2vw ;
      }
    </style>
  </head>

  <body style="padding-top: 0vh; padding-bottom: 0px">
    <!-- CODIGO DO SOM -->

    <audio
      id="reload-sound"
      src="https://neseg.com.br/painel/matriz/Imagens%20Site/reload-sound.mp3"
      preload="auto"
    ></audio>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      let lastUpdate = "";

      function checkForUpdates() {
        $.ajax({
          url: "check_update.php",
          method: "GET",
          success: function (data) {
            if (lastUpdate !== "" && lastUpdate !== data) {
              const audio = document.getElementById("reload-sound");
              audio
                .play()
                .then(() => {
                  setTimeout(() => {
                    location.reload();
                  }, 1000); // Atraso para permitir que o som toque
                })
                .catch((error) => {
                  console.error("Erro ao reproduzir som:", error);
                  location.reload(); // Se não puder tocar o som, recarregar imediatamente
                });
            }
            lastUpdate = data;
          },
          error: function (xhr, status, error) {
            console.error("Erro na solicitação AJAX:", error);
          },
        });
      }

      $(document).ready(function () {
        lastUpdate = ""; // Inicializa lastUpdate para evitar o reload imediato
        setInterval(checkForUpdates, 10000); // Verifica a cada 5 segundos

        // Adiciona um evento de clique para o botão de reprodução de som
        $("#play-sound-button").on("click", function () {
          const audio = document.getElementById("reload-sound");
          audio.play().catch((error) => {
            console.error("Erro ao reproduzir som ao clicar:", error);
          });
        });
      });
    </script>

    <!-- CODIGO DO SOM 
    <audio id="reload-sound" src="https://www.neseg.com.br/painel/matriz/Imagens%20Site/reload-sound.mp3" preload="auto"></audio>
    <?php echo $_SESSION['usuarioNome']; ?>
    <?php echo $_SESSION['usuarioCargo']; ?>
    <script>
        document.getElementById("all").addEventListener("click", function() {
                        checkBoxs = document.querySelectorAll('input[type="checkbox"]:not([id=all])');
                        //"Hack": http://toddmotto.com/ditch-the-array-foreach-call-nodelist-hack/
                        [].forEach.call(checkBoxs, function(checkbox) {
                            checkbox.checked = checkbox.checked ? false : true;
                        });
                    });
                </script>
                <?php
                while ($row_msg_contatos = mysqli_fetch_assoc($resultado_msg_contatos)) {
                    $dataa = DateTime::createFromFormat('d-m-y H:i:s', $row_msg_contatos['data']);
                    $data = $row_msg_contatos["data"];
                    $id = $row_msg_contatos["id"];
                    ?>

                    <tr>
                        <td class="text-center">
                            <input type="checkbox" name="msg_contato[<?php echo $id; ?>]" value="1">
                        </td>
                        <td class="text-center"><?php echo $id; ?></td>
                        <td class="text-center"><?php echo (new DateTime($row_msg_contatos['datadopedido']))->format('d-m-y'); ?></td>
                        <td class="text-center"><?php echo $row_msg_contatos["nomecompleto"]; ?></td>
                        <td class="text-center"><?php echo $row_msg_contatos["funcao"]; ?></td>
                        <td class="text-center"><?php echo $row_msg_contatos["posto"]; ?></td>
                        <td class="text-center"><?php echo $row_msg_contatos["qualfilial"]; ?></td>
                        
            <td class="text-center"><?php echo $row_msg_contatos["quempediu"]; ?></td>
            <td class="text-center"><?php echo $row_msg_contatos["datainiciotrab"]; ?></td>
            <td class="text-center"><?php echo $row_msg_contatos["camisa"]; ?>
                <?php echo $row_msg_contatos["calca"]; ?>
                <?php echo $row_msg_contatos["sapato"]; ?>
                <?php echo $row_msg_contatos["terno"]; ?>
                <?php echo $row_msg_contatos["epi"]; ?></td>
                <td class="text-center"><?php echo $row_msg_contatos["statuscontrato"]; ?></td>
                
                <td class="text-center">
                    <a href="avaliacaoeditar?codigo=<?= $row_msg_contatos["id"] ?>" target="_blank">
                        <button type="button" class="btn btn-secondary" style="width: 100%;">ATUALIZAR</button>
                    </a>

                </td>


                
            </tr>
            <?php } ?>
            <?php
            if (!isset($_POST['nome'])) {
                
            //Verificar pagina anterior e posterior
            $pagina_anterior = $pagina - 1;
            $pagina_posterior = $pagina + 1;
            ?>
            <nav class="text-center">
                <ul class="pagination">
                    <li>
                        <?php
                        if ($pagina_anterior != 0) {
                            ?><a href="almoxarifado.php?link=100&pagina=<?php echo $pagina_anterior; ?>" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a><?php
                        } else {
                            ?><span aria-hidden="true">&laquo;</span><?php
                        }
                        ?>
                    </li>
                    <?php
                    //Apresentar a paginação
                    for ($i = 1; $i < $num_pagina + 1; $i++) {
                        ?>
                        <li><a href="almoxarifado.php?link=100&pagina=<?php echo $i; ?>">
                            <?php echo $i; ?>
                        </a></li>
                        <?php
                    }
                    ?>
                    <li>
                        <?php
                        if ($pagina_posterior <= $num_pagina) {
                            ?><a href="almoxarifado.php?link=50&pagina=<?php echo $pagina_posterior; ?>" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a><?php
                        } else {
                            ?><span aria-hidden="true">&raquo;</span><?php
                        }
                        ?>
                    </li>
                </ul>
            </nav>
            <?php } ?>
            -->

    <!--REFAZENDO-->
    <nav class="sidebar">
      <div class="sidebarPerfil">
        <img src="logo.png" alt="" class="sidebarPerfilImg" />
        <div class="sidebarPerfilText">
          <h1>NOME</h1>
          <h3>Cargo</h3>
        </div>
      </div>
      <div class="sidebarRotas">
        <h3>Menu Principal</h3>
        <a href="">Entradas</a>
        <a href="">Saidas</a>
        <a href="">Estoque</a>
      </div>
    </nav>

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="js/ie10-viewport-bug-workaround.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>
